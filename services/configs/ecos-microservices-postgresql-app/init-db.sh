#!/bin/bash
if [ "$WITH_DEMO_DATA" == "true" ]; then
  echo "Restoring demo dump..."
  psql -U postgres << EODUMP
  \i /tmp/dump_demo.sql
EODUMP

else
  echo "Create DB.."
  set -e
  psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL

      CREATE USER ${ECOS_PROCESS_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_PROCESS_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_PROCESS_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_PROCESS_APP_DATASOURCE_DATABASE} TO ${ECOS_PROCESS_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_CAMUNDA_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_CAMUNDA_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_CAMUNDA_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_CAMUNDA_APP_DATASOURCE_DATABASE} TO ${ECOS_CAMUNDA_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_APPS_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_APPS_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_APPS_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_APPS_APP_DATASOURCE_DATABASE} TO ${ECOS_APPS_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_GATEWAY_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_GATEWAY_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_GATEWAY_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_GATEWAY_APP_DATASOURCE_DATABASE} TO ${ECOS_GATEWAY_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_UISERV_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_UISERV_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_UISERV_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_UISERV_APP_DATASOURCE_DATABASE} TO ${ECOS_UISERV_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_INTEGRATIONS_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_INTEGRATIONS_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_INTEGRATIONS_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_INTEGRATIONS_APP_DATASOURCE_DATABASE} TO ${ECOS_INTEGRATIONS_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_MODEL_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_MODEL_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_MODEL_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_MODEL_APP_DATASOURCE_DATABASE} TO ${ECOS_MODEL_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_NOTIFICATIONS_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_NOTIFICATIONS_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_NOTIFICATIONS_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_NOTIFICATIONS_APP_DATASOURCE_DATABASE} TO ${ECOS_NOTIFICATIONS_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_HISTORY_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_HISTORY_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_HISTORY_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_HISTORY_APP_DATASOURCE_DATABASE} TO ${ECOS_HISTORY_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_CASEMODEL_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_CASEMODEL_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_CASEMODEL_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_CASEMODEL_APP_DATASOURCE_DATABASE} TO ${ECOS_CASEMODEL_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_JIRA_REPORTS_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_JIRA_REPORTS_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_JIRA_REPORTS_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_JIRA_REPORTS_APP_DATASOURCE_DATABASE} TO ${ECOS_JIRA_REPORTS_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_IDENTITY_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_IDENTITY_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_IDENTITY_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_IDENTITY_APP_DATASOURCE_DATABASE} TO ${ECOS_IDENTITY_APP_DATASOURCE_USERNAME};

      CREATE USER ${ECOS_EDI_APP_DATASOURCE_USERNAME} WITH ENCRYPTED PASSWORD '${ECOS_EDI_APP_DATASOURCE_PASSWORD}';
      CREATE DATABASE ${ECOS_EDI_APP_DATASOURCE_DATABASE};
      GRANT ALL PRIVILEGES ON DATABASE ${ECOS_EDI_APP_DATASOURCE_DATABASE} TO ${ECOS_EDI_APP_DATASOURCE_USERNAME};

      CREATE EXTENSION pg_stat_statements SCHEMA public;
EOSQL
fi

exec "$@"